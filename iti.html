<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ITI Taiyaari</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
/* --- 1. THEME VARIABLES --- */
:root {
  /* Light Mode */
  --primary: #0f766e;
  --primary-light: #ccfbf1;
  --primary-dark: #115e59;
  --bg-color: #f1f5f9;
  --white: #ffffff;
  --text-main: #0f172a;
  --text-sub: #64748b;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  --border: #e2e8f0;
}

/* Dark Mode Overrides */
[data-theme="dark"] {
  --primary: #2dd4bf;
  --primary-light: #134e4a;
  --primary-dark: #0f766e;
  --bg-color: #0f172a;
  --white: #1e293b;
  --text-main: #f1f5f9;
  --text-sub: #94a3b8;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
  --border: #334155;
}

body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); margin: 0; display: flex; justify-content: center; color: var(--text-main); transition: background 0.3s, color 0.3s; }
.app-container { width: 100%; max-width: 500px; background: var(--white); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; transition: background 0.3s; }

/* HEADER */
.header { background: linear-gradient(135deg,var(--primary-dark),var(--primary)); color: #fff; padding: 30px 20px 40px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; position: relative; box-shadow: 0 4px 15px rgba(15,118,110,0.2); }
.header a { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; position: absolute; top: 20px; left: 20px; }
.header h1 { margin: 15px 0 5px; font-size: 24px; font-weight: 700; }
.header p { margin: 0; opacity: 0.9; font-size: 14px; }

/* THEME TOGGLE BUTTON */
.theme-btn { position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.2); border: none; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; transition: 0.2s; backdrop-filter: blur(5px); }
.theme-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(15deg); }

/* PROGRESS BAR */
#progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: rgba(255,255,255,0.3); display: none; }
#progress-fill { height: 100%; background: #ffffff; width: 0%; transition: width 0.3s ease; border-top-right-radius: 4px; }

/* SKELETON LOADING */
.skeleton { background: var(--border); border-radius: 8px; animation: pulse 1.5s infinite; margin-bottom: 15px; }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
.sk-text { height: 20px; width: 60%; margin: 20px auto; }
.sk-card { height: 80px; width: 100%; }
#loading-overlay { padding: 30px; text-align: center; }

/* SCREENS */
.screen { display: none; padding: 25px; flex-grow: 1; animation: fadeIn .3s ease; }
.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* CARDS & BUTTONS */
.menu-card { background: var(--white); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; transition: .2s; box-shadow: var(--shadow); }
.menu-card:hover { border-color: var(--primary); transform: translateY(-2px); }

.question-card { background: var(--white); border: 1px solid var(--border); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow); }
.q-text { font-size: 18px; font-weight: 600; color: var(--text-main); margin-bottom: 20px; line-height: 1.5; }

.opt-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; border: 1px solid var(--border); background: var(--white); border-radius: 12px; text-align: left; font-size: 16px; cursor: pointer; transition: .2s; color: var(--text-main); }
.opt-btn:hover { border-color: var(--primary); background: var(--bg-color); }

.correct { background: #dcfce7!important; border-color: #22c55e!important; color: #14532d!important; }
.wrong { background: #fee2e2!important; border-color: #ef4444!important; color: #7f1d1d!important; }

/* Dark mode specific colors for readability */
[data-theme="dark"] .correct { background: #064e3b!important; color: #d1fae5!important; border-color: #34d399!important; }
[data-theme="dark"] .wrong { background: #450a0a!important; color: #fecaca!important; border-color: #f87171!important; }

.action-btn { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 6px rgba(15,118,110,0.2); transition: .2s; }
.action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.secondary-btn { background: var(--text-sub); }
.share-btn { background: #25D366; }
.review-btn { background: #3b82f6; }

#timer-box { text-align: right; font-weight: bold; color: #dc2626; margin-bottom: 10px; display: none; font-size: 18px; }
.review-item { border-bottom: 1px solid var(--border); padding: 15px 0; }
.review-q { font-weight: bold; margin-bottom: 5px; color: var(--text-main); }
.review-ans { font-size: 14px; color: var(--text-sub); }
.ans-right { color: var(--primary); font-weight: bold; }
.explanation { font-size: 13px; color: var(--primary); background: var(--primary-light); padding: 10px; border-radius: 8px; margin-top: 8px; }
</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <a href="index.html" id="lbl-home">‚Üê Home</a>
    <button class="theme-btn" onclick="toggleTheme()">üåì</button>
    <h1 id="lbl-title">ITI Taiyaari</h1>
    <p id="lbl-subtitle">Electrician & Fitter</p>
    
    <div id="progress-container">
      <div id="progress-fill"></div>
    </div>
  </div>

  <div id="loading-overlay">
    <div class="skeleton sk-text"></div>
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
    <div style="color:var(--text-sub); margin-top:10px;">Connecting to Cloud Database...</div>
  </div>

  <div id="screen-modes" class="screen">
    <h3 style="color:var(--text-sub);margin-bottom:20px;" id="lbl-select">Select Mode:</h3>

    <div class="menu-card" id="btn-practice" onclick="startPractice()">
      <span style="font-size:24px;margin-right:15px">üìù</span>
      <div><strong id="lbl-prac">Practice Quiz</strong><br><span style="font-size:12px;color:var(--text-sub)" id="lbl-prac-sub">Instant Feedback</span></div>
    </div>

    <div class="menu-card" id="btn-exam" onclick="startExam()">
      <span style="font-size:24px;margin-right:15px">‚è±Ô∏è</span>
      <div><strong id="lbl-test">Test Mode</strong><br><span style="font-size:12px;color:var(--text-sub)" id="lbl-test-sub">Time Limit</span></div>
    </div>
  </div>

  <div id="screen-quiz" class="screen">
    <div id="timer-box">‚è≥ <span id="time-left">00:00</span></div>
    <div class="question-card">
      <div style="font-size:12px;color:var(--text-sub);margin-bottom:10px;"><span id="lbl-qnum">Question</span> <span id="q-num">1</span></div>
      <div id="q-text" class="q-text">Loading...</div>
      <div id="opts"></div>
    </div>
    <div id="feedback" style="text-align:center;font-weight:bold;height:20px;margin-bottom:10px"></div>
  </div>

  <div id="screen-result" class="screen" style="text-align:center">
    <h2 id="lbl-scorecard">Score Card</h2>
    <h1 id="score" style="font-size:48px;color:var(--primary);margin:20px 0">0/0</h1>
    <p id="result-msg" style="color:var(--text-sub);font-size:18px">...</p>
    <button class="action-btn review-btn" id="btn-review" onclick="showReview()">Review Answers üßê</button>
    <button class="action-btn share-btn" id="btn-share" onclick="shareScore()">Share Score üì≤</button>
    <button class="action-btn secondary-btn" id="btn-menu" onclick="goToMenu()">Back to Menu üè†</button>
  </div>

  <div id="screen-review" class="screen">
    <h3 id="lbl-review">Review Answers</h3>
    <div id="review-list" style="overflow-y:auto;max-height:60vh"></div>
    <button class="action-btn secondary-btn" id="btn-close" onclick="closeReview()">Close</button>
  </div>
</div>

<script>
/* --- CONFIG --- */
const SHEET_URLS = {
  en: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=0&single=true&output=csv",
  hi: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=1440984595&single=true&output=csv",
  mr: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=2496928&single=true&output=csv",
  ta: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=703350&single=true&output=csv",
  te: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=390730614&single=true&output=csv",
  bn: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=901218882&single=true&output=csv"
};

const urlParams = new URLSearchParams(window.location.search);
const lang = urlParams.get('lang') || 'en';

/* --- DARK MODE LOGIC --- */
function toggleTheme() {
  const body = document.body;
  const isDark = body.getAttribute('data-theme') === 'dark';
  if (isDark) {
    body.removeAttribute('data-theme');
    localStorage.setItem('theme', 'light');
  } else {
    body.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  }
}
if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

/* --- UI TEXT --- */
const ui = {
  en:{title:"ITI Taiyaari",sub:"Electrician & Fitter",home:"‚Üê Home",select:"Select Mode:",prac:"Practice Quiz",pracSub:"Instant Feedback",test:"Test Mode",testSub:"Time Limit",qnum:"Question",score:"Score Card",review:"Review Answers",share:"Share Score",menu:"Back to Menu",close:"Close"},
  hi:{title:"‡§Ü‡§à‡§ü‡•Ä‡§Ü‡§à ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä",sub:"‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä‡§∂‡§ø‡§Ø‡§® ‡§î‡§∞ ‡§´‡§ø‡§ü‡§∞",home:"‚Üê ‡§π‡•ã‡§Æ",select:"‡§Æ‡•ã‡§° ‡§ö‡•Å‡§®‡•á‡§Ç:",prac:"‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º",pracSub:"‡§§‡•Å‡§∞‡§Ç‡§§ ‡§â‡§§‡•ç‡§§‡§∞",test:"‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§Æ‡•ã‡§°",testSub:"‡§∏‡§Æ‡§Ø ‡§∏‡•Ä‡§Æ‡§æ",qnum:"‡§™‡•ç‡§∞‡§∂‡•ç‡§®",score:"‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§°",review:"‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç",share:"‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç",menu:"‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç",close:"‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç"},
  mr:{title:"‡§Ü‡§Ø.‡§ü‡•Ä.‡§Ü‡§Ø. ‡§§‡§Ø‡§æ‡§∞‡•Ä",sub:"‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§∂‡§ø‡§Ø‡§® ‡§Ü‡§£‡§ø ‡§´‡§ø‡§ü‡§∞",home:"‚Üê ‡§π‡•ã‡§Æ",select:"‡§Æ‡•ã‡§° ‡§®‡§ø‡§µ‡§°‡§æ:",prac:"‡§∏‡§∞‡§æ‡§µ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§Æ‡§Ç‡§ú‡•Å‡§∑‡§æ",pracSub:"‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§â‡§§‡•ç‡§§‡§∞‡•á",test:"‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§Æ‡•ã‡§°",testSub:"‡§µ‡•á‡§≥ ‡§Æ‡§∞‡•ç‡§Ø‡§æ‡§¶‡§æ",qnum:"‡§™‡•ç‡§∞‡§∂‡•ç‡§®",score:"‡§ó‡•Å‡§£‡§™‡§§‡•ç‡§∞‡§ï",review:"‡§â‡§§‡•ç‡§§‡§∞‡•á ‡§§‡§™‡§æ‡§∏‡§æ",share:"‡§ó‡•Å‡§£ ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ",menu:"‡§Æ‡•á‡§®‡•Ç‡§µ‡§∞ ‡§ú‡§æ",close:"‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ"},
  ta:{title:"‡Æê‡Æü‡Æø‡Æê ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",sub:"‡Æé‡Æ≤‡Æï‡Øç‡Æü‡Øç‡Æ∞‡ØÄ‡Æ∑‡Æø‡ÆØ‡Æ©‡Øç & ‡Æ™‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç",home:"‚Üê ‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ",select:"‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ:",prac:"‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø ‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø ‡Æµ‡Æø‡Æ©‡Ææ",pracSub:"‡Æâ‡Æü‡Æ©‡Æü‡Æø ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç",test:"‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æ±‡Øà",testSub:"‡Æ®‡Øá‡Æ∞ ‡Æµ‡Æ∞‡ÆÆ‡Øç‡Æ™‡ØÅ",qnum:"‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø",score:"‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç ‡ÆÖ‡Æü‡Øç‡Æü‡Øà",review:"‡Æ™‡Æ§‡Æø‡Æ≤‡Øç‡Æï‡Æ≥‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",share:"‡Æ™‡Æï‡Æø‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç",menu:"‡ÆÆ‡ØÜ‡Æ©‡ØÅ",close:"‡ÆÆ‡ØÇ‡Æü‡ØÅ"},
  te:{title:"ITI ‡∞§‡∞Ø‡∞æ‡∞∞‡±Ä",sub:"‡∞é‡∞≤‡∞ï‡±ç‡∞ü‡±ç‡∞∞‡±Ä‡∞∑‡∞ø‡∞Ø‡∞®‡±ç & ‡∞´‡∞ø‡∞ü‡±ç‡∞ü‡∞∞‡±ç",home:"‚Üê ‡∞π‡±ã‡∞Æ‡±ç",select:"‡∞Æ‡±ã‡∞°‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø:",prac:"‡∞™‡±ç‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡±Ä‡∞∏‡±ç ‡∞ï‡±ç‡∞µ‡∞ø‡∞ú‡±ç",pracSub:"‡∞§‡∞ï‡±ç‡∞∑‡∞£ ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç",test:"‡∞™‡∞∞‡±Ä‡∞ï‡±ç‡∞∑ ‡∞Æ‡±ã‡∞°‡±ç",testSub:"‡∞∏‡∞Æ‡∞Ø ‡∞™‡∞∞‡∞ø‡∞Æ‡∞ø‡∞§‡∞ø",qnum:"‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®",score:"‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç",review:"‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞æ‡∞≤‡±Å",share:"‡∞≠‡∞æ‡∞ó‡∞∏‡±ç‡∞µ‡∞æ‡∞Æ‡±ç‡∞Ø‡∞Ç",menu:"‡∞Æ‡±Ü‡∞®‡±Å",close:"‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø"},
  bn:{title:"‡¶Ü‡¶á‡¶ü‡¶ø‡¶Ü‡¶á ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø",sub:"‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡¶ø‡¶ü‡¶æ‡¶∞",home:"‚Üê ‡¶π‡ßã‡¶Æ",select:"‡¶Æ‡ßã‡¶° ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:",prac:"‡¶Ö‡¶®‡ßÅ‡¶∂‡ßÄ‡¶≤‡¶® ‡¶ï‡ßÅ‡¶á‡¶ú",pracSub:"‡¶§‡¶æ‡¶§‡ßç‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞",test:"‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßã‡¶°",testSub:"‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßÄ‡¶Æ‡¶æ",qnum:"‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®",score:"‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶°",review:"‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®",share:"‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",menu:"‡¶Æ‡ßá‡¶®‡ßÅ",close:"‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®"}
};

const t = ui[lang] || ui.en;
document.getElementById('lbl-title').innerText = t.title;
document.getElementById('lbl-subtitle').innerText = t.sub;
document.getElementById('lbl-home').innerText = t.home;
document.getElementById('lbl-select').innerText = t.select;
document.getElementById('lbl-prac').innerText = t.prac;
document.getElementById('lbl-prac-sub').innerText = t.pracSub;
document.getElementById('lbl-test').innerText = t.test;
document.getElementById('lbl-test-sub').innerText = t.testSub;
document.getElementById('lbl-qnum').innerText = t.qnum;
document.getElementById('lbl-scorecard').innerText = t.score;
document.getElementById('btn-review').innerText = t.review;
document.getElementById('btn-share').innerText = t.share;
document.getElementById('btn-menu').innerText = t.menu;
document.getElementById('lbl-review').innerText = t.review;
document.getElementById('btn-close').innerText = t.close;

/* --- LOGIC --- */
let masterData = [], fullQuestionPool = [], currentSessionQuestions = [], userAnswers = [], idx = 0, score = 0, timerInterval;

function loadData(){
  Papa.parse(SHEET_URLS[lang], {
    download:true, header:true, skipEmptyLines:true,
    complete: res => {
      masterData = res.data.filter(r => r.q);
      if(masterData.length){
        // Hide Skeleton, Show Modes
        document.getElementById("loading-overlay").style.display = "none";
        document.getElementById("screen-modes").classList.add("active");
      }
    }
  });
}
loadData();

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

function startPractice(){
  fullQuestionPool = shuffle([...masterData]);
  currentSessionQuestions = fullQuestionPool.slice(0, Math.min(5, fullQuestionPool.length));
  setupScreen("practice");
}

function startExam(){
  fullQuestionPool = shuffle([...masterData]);
  currentSessionQuestions = fullQuestionPool.slice(0, Math.min(30, masterData.length));
  setupScreen("exam");
  startTimer(600);
}

function setupScreen(mode){
  document.getElementById("screen-modes").classList.remove("active");
  document.getElementById("screen-result").classList.remove("active");
  document.getElementById("screen-review").classList.remove("active");
  document.getElementById("screen-quiz").classList.add("active");
  document.getElementById("timer-box").style.display = mode === "practice" ? "none" : "block";
  document.getElementById("progress-container").style.display = "block"; // Show bar
  idx = 0; score = 0; userAnswers = [];
  loadQ();
}

function loadQ(){
  if(idx >= currentSessionQuestions.length){ showRes(); return; }

  // Update Progress Bar
  const pct = ((idx) / currentSessionQuestions.length) * 100;
  document.getElementById("progress-fill").style.width = pct + "%";

  const q = currentSessionQuestions[idx];
  document.getElementById("q-num").innerText = idx+1;
  document.getElementById("q-text").innerText = q.q;
  const box = document.getElementById("opts");
  box.innerHTML = "";
  document.getElementById("feedback").innerText = "";

  const opts = [q.o1,q.o2,q.o3,q.o4].filter(v => v);
  const correct = Math.max(0, (parseInt(q.a)-1) || 0);
  const btns = [];

  opts.forEach((opt,i)=>{
    const b = document.createElement("button");
    b.className = "opt-btn";
    b.innerText = opt;
    btns.push(b);

    b.onclick = () => {
      btns.forEach(x=>x.disabled=true);
      userAnswers.push({ q:q.q,sel:i,cor:correct,opts:opts,exp:q.explain });

      if(i===correct){
        b.classList.add("correct");
        score++;
        feedback("Correct","var(--primary)"); // Use Theme Color
      }else{
        b.classList.add("wrong");
        if(btns[correct]) btns[correct].classList.add("correct");
        feedback("Wrong","#ef4444");
      }

      setTimeout(()=>{idx++;loadQ();},1000);
    };
    box.appendChild(b);
  });
}

function feedback(msg,color){
  const f = document.getElementById("feedback");
  f.innerText = msg === "Correct" ? "‚úÖ Correct" : "‚ùå Wrong";
  // If color is var(--primary), let CSS handle it via class or just set it
  f.style.color = color;
}

function showRes(){
  clearInterval(timerInterval);
  document.getElementById("screen-quiz").classList.remove("active");
  document.getElementById("screen-result").classList.add("active");
  document.getElementById("progress-container").style.display = "none"; // Hide bar

  const total = currentSessionQuestions.length;
  const pct = Math.round((score/total)*100);

  document.getElementById("score").innerText = `${score}/${total}`;

  if(pct>=80){
    document.getElementById("result-msg").innerText = `üéâ Amazing! You scored ${pct}%!`;
    document.getElementById("result-msg").style.color="var(--primary)";
    confetti({particleCount:120,spread:70,origin:{y:0.6}});
  }else{
    document.getElementById("result-msg").innerText = `üìö Keep practicing! You scored ${pct}%.`;
    document.getElementById("result-msg").style.color="var(--text-sub)";
  }
}

function showReview(){
  document.getElementById("screen-result").classList.remove("active");
  document.getElementById("screen-review").classList.add("active");

  const list = document.getElementById("review-list");
  list.innerHTML = "";

  userAnswers.forEach((item,i)=>{
    const div = document.createElement("div");
    div.className="review-item";
    
    // Status Icon
    const statusIcon = item.sel===item.cor ? "‚úÖ" : "‚ùå";
    // Check dark mode for color adjustments if needed, but var usage handles most
    const statusColor = item.sel===item.cor ? "var(--primary)" : "#ef4444";

    div.innerHTML = `
      <div class="review-q">${i+1}. ${item.q}</div>
      <div class="review-ans">You: <b>${item.opts[item.sel]||""}</b> <span style="color:${statusColor}">${statusIcon}</span></div>
      ${item.sel!==item.cor ? `<div class="ans-right">Ans: ${item.opts[item.cor]}</div>` : ""}
      ${item.exp ? `<div class="explanation">üí° <b>Explanation:</b> ${item.exp}</div>`:""}
    `;
    list.appendChild(div);
  });
}

function closeReview(){
  document.getElementById("screen-review").classList.remove("active");
  document.getElementById("screen-result").classList.add("active");
}

function shareScore(){
  window.open("https://wa.me/?text=" + encodeURIComponent(`üî• I scored ${score}/${currentSessionQuestions.length} in ITI Taiyaari!`),"blank");
}

function goToMenu(){
  // Reload to reset state fully
  window.location.reload();
}

function startTimer(sec){
  const tl = document.getElementById("time-left");
  timerInterval = setInterval(()=>{
    let m = Math.floor(sec/60), s = sec%60;
    tl.innerText = `${m<10?"0"+m:m}:${s<10?"0"+s:s}`;
    if(sec-- <= 0){ clearInterval(timerInterval); showRes(); }
  },1000);
}
</script>

</body>
</html>
