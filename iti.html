<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ITI Taiyaari</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
  --primary:#0f766e; --primary-light:#ccfbf1; --primary-dark:#115e59;
  --bg-color:#f1f5f9; --white:#fff; --text-main:#0f172a; --text-sub:#64748b;
  --shadow:0 4px 6px -1px rgba(0,0,0,0.1);
}
body{font-family:Segoe UI, Roboto, sans-serif;background:var(--bg-color);margin:0;display:flex;justify-content:center;color:var(--text-main)}
.app-container{width:100%;max-width:500px;background:var(--white);min-height:100vh;box-shadow:0 0 20px rgba(0,0,0,0.05);display:flex;flex-direction:column}
.header{background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:#fff;padding:30px 20px 40px;border-bottom-left-radius:24px;border-bottom-right-radius:24px;position:relative;box-shadow:0 4px 15px rgba(15,118,110,0.2)}
.header a{color:rgba(255,255,255,0.8);text-decoration:none;font-size:14px;position:absolute;top:20px;left:20px}
.header h1{margin:15px 0 5px;font-size:24px;font-weight:700}
.header p{margin:0;opacity:0.9;font-size:14px}

.screen{display:none;padding:25px;flex-grow:1;animation:fadeIn .3s ease}
.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.menu-card{background:var(--white);border:1px solid #e2e8f0;border-radius:16px;padding:20px;margin-bottom:15px;cursor:pointer;display:flex;align-items:center;transition:.2s;box-shadow:var(--shadow)}
.menu-card:hover{border-color:var(--primary);background:var(--primary-light);transform:translateY(-2px)}

#timer-box{text-align:right;font-weight:bold;color:#dc2626;margin-bottom:10px;display:none;font-size:18px}
.question-card{background:var(--white);border:1px solid #e2e8f0;border-radius:16px;padding:25px;margin-bottom:20px;box-shadow:var(--shadow)}
.q-text{font-size:18px;font-weight:600;color:var(--text-main);margin-bottom:20px;line-height:1.5}

.opt-btn{display:block;width:100%;padding:15px;margin-bottom:10px;border:1px solid #e2e8f0;background:#f8fafc;border-radius:12px;text-align:left;font-size:16px;cursor:pointer;transition:.2s;color:var(--text-main)}
.opt-btn:hover{border-color:var(--primary);background:white}

.correct{background:#dcfce7!important;border-color:#22c55e!important;color:#14532d!important}
.wrong{background:#fee2e2!important;border-color:#ef4444!important;color:#7f1d1d!important}

.action-btn{background:var(--primary);color:white;border:none;padding:16px;width:100%;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:10px;box-shadow:0 4px 6px rgba(15,118,110,0.2);transition:.2s}
.action-btn:hover{background:var(--primary-dark)}
.action-btn:disabled{background:#cbd5e1;cursor:not-allowed;box-shadow:none}
.secondary-btn{background:var(--text-sub)}
.share-btn{background:#25D366}
.review-btn{background:#3b82f6}

.review-item{border-bottom:1px solid #e2e8f0;padding:15px 0}
.review-q{font-weight:bold;margin-bottom:5px;color:#333}
.review-ans{font-size:14px;color:#666}
.ans-right{color:#16a34a;font-weight:bold}
.explanation{font-size:13px;color:var(--primary-dark);background:var(--primary-light);padding:10px;border-radius:8px;margin-top:8px}

#loading-msg{text-align:center;margin-top:20px;color:var(--text-sub);font-weight:500;font-size:14px}
</style>
</head>
<body>
<div class="app-container">
  <div class="header">
    <a href="index.html" id="lbl-home">‚Üê Home</a>
    <h1 id="lbl-title">ITI Taiyaari</h1>
    <p id="lbl-subtitle">Electrician & Fitter</p>
  </div>

  <div id="screen-modes" class="screen active">
    <h3 style="color:var(--text-sub);margin-bottom:20px;" id="lbl-select">Select Mode:</h3>
    <div id="loading-msg">‚è≥ Connecting to Question Bank...</div>

    <div class="menu-card" id="btn-practice" style="opacity:.5;pointer-events:none" onclick="startPractice()">
      <span style="font-size:24px;margin-right:15px">üìù</span>
      <div><strong id="lbl-prac">Practice Quiz</strong><br><span style="font-size:12px;color:var(--text-sub)" id="lbl-prac-sub">Instant Feedback</span></div>
    </div>

    <div class="menu-card" id="btn-exam" style="opacity:.5;pointer-events:none" onclick="startExam()">
      <span style="font-size:24px;margin-right:15px">‚è±Ô∏è</span>
      <div><strong id="lbl-test">Test Mode</strong><br><span style="font-size:12px;color:var(--text-sub)" id="lbl-test-sub">Time Limit</span></div>
    </div>
  </div>

  <div id="screen-quiz" class="screen">
    <div id="timer-box">‚è≥ <span id="time-left">00:00</span></div>
    <div class="question-card">
      <div style="font-size:12px;color:var(--text-sub);margin-bottom:10px;"><span id="lbl-qnum">Question</span> <span id="q-num">1</span></div>
      <div id="q-text" class="q-text">Loading...</div>
      <div id="opts"></div>
    </div>
    <div id="feedback" style="text-align:center;font-weight:bold;height:20px;margin-bottom:10px"></div>
  </div>

  <div id="screen-result" class="screen" style="text-align:center">
    <h2 id="lbl-scorecard">Score Card</h2>
    <h1 id="score" style="font-size:48px;color:var(--primary);margin:20px 0">0/0</h1>
    <p id="result-msg" style="color:var(--text-sub);font-size:18px">...</p>
    <button class="action-btn review-btn" id="btn-review" onclick="showReview()">Review Answers üßê</button>
    <button class="action-btn share-btn" id="btn-share" onclick="shareScore()">Share Score üì≤</button>
    <button class="action-btn secondary-btn" id="btn-menu" onclick="goToMenu()">Back to Menu üè†</button>
  </div>

  <div id="screen-review" class="screen">
    <h3 id="lbl-review">Review Answers</h3>
    <div id="review-list" style="overflow-y:auto;max-height:60vh"></div>
    <button class="action-btn secondary-btn" id="btn-close" onclick="closeReview()">Close</button>
  </div>
</div>

<script>
/* ---------- CONFIG: replace these CSV publish URLs with your sheets ---------- */
const SHEET_URLS = {
  en: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=0&single=true&output=csv",
  hi: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=1440984595&single=true&output=csv",
  mr: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=2496928&single=true&output=csv",
  ta: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=703350&single=true&output=csv",
  te: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=390730614&single=true&output=csv",
  bn: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLVDGFJpFOr6NuvZ8gBU1ClBEPrQv6DYsQ54hbTDSsVmem3ZCsrdBrFtupirN4ihCRtFVLjT2M7O7_/pub?gid=901218882&single=true&output=csv"
};
/* -------------------------------------------------------------------------- */

const urlParams = new URLSearchParams(window.location.search);
const lang = urlParams.get('lang') || 'en';

const ui = {
  en:{title:"ITI Taiyaari",sub:"Electrician & Fitter",home:"‚Üê Home",select:"Select Mode:",prac:"Practice Quiz",pracSub:"Instant Feedback",test:"Test Mode",testSub:"Time Limit",qnum:"Question",score:"Score Card",review:"Review Answers",share:"Share Score",menu:"Back to Menu",close:"Close"},
  hi:{title:"‡§Ü‡§à‡§ü‡•Ä‡§Ü‡§à ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä",sub:"‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä‡§∂‡§ø‡§Ø‡§® ‡§î‡§∞ ‡§´‡§ø‡§ü‡§∞",home:"‚Üê ‡§π‡•ã‡§Æ",select:"‡§Æ‡•ã‡§° ‡§ö‡•Å‡§®‡•á‡§Ç:",prac:"‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º",pracSub:"‡§§‡•Å‡§∞‡§Ç‡§§ ‡§â‡§§‡•ç‡§§‡§∞",test:"‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§Æ‡•ã‡§°",testSub:"‡§∏‡§Æ‡§Ø ‡§∏‡•Ä‡§Æ‡§æ",qnum:"‡§™‡•ç‡§∞‡§∂‡•ç‡§®",score:"‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§°",review:"‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç",share:"‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç",menu:"‡§Æ‡•á‡§®‡•ç‡§Ø‡•Ç ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç",close:"‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç"},
  mr:{title:"‡§Ü‡§Ø.‡§ü‡•Ä.‡§Ü‡§Ø. ‡§§‡§Ø‡§æ‡§∞‡•Ä",sub:"‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§∂‡§ø‡§Ø‡§® ‡§Ü‡§£‡§ø ‡§´‡§ø‡§ü‡§∞",home:"‚Üê ‡§π‡•ã‡§Æ",select:"‡§Æ‡•ã‡§° ‡§®‡§ø‡§µ‡§°‡§æ:",prac:"‡§∏‡§∞‡§æ‡§µ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§Æ‡§Ç‡§ú‡•Å‡§∑‡§æ",pracSub:"‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§â‡§§‡•ç‡§§‡§∞‡•á",test:"‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§Æ‡•ã‡§°",testSub:"‡§µ‡•á‡§≥ ‡§Æ‡§∞‡•ç‡§Ø‡§æ‡§¶‡§æ",qnum:"‡§™‡•ç‡§∞‡§∂‡•ç‡§®",score:"‡§ó‡•Å‡§£‡§™‡§§‡•ç‡§∞‡§ï",review:"‡§â‡§§‡•ç‡§§‡§∞‡•á ‡§§‡§™‡§æ‡§∏‡§æ",share:"‡§ó‡•Å‡§£ ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ",menu:"‡§Æ‡•á‡§®‡•Ç‡§µ‡§∞ ‡§ú‡§æ",close:"‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ"},
  ta:{title:"‡Æê‡Æü‡Æø‡Æê ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",sub:"‡Æé‡Æ≤‡Æï‡Øç‡Æü‡Øç‡Æ∞‡ØÄ‡Æ∑‡Æø‡ÆØ‡Æ©‡Øç & ‡Æ™‡Æø‡Æü‡Øç‡Æü‡Æ∞‡Øç",home:"‚Üê ‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ",select:"‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ:",prac:"‡Æ™‡ÆØ‡Æø‡Æ±‡Øç‡Æö‡Æø ‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø ‡Æµ‡Æø‡Æ©‡Ææ",pracSub:"‡Æâ‡Æü‡Æ©‡Æü‡Æø ‡Æ™‡Æ§‡Æø‡Æ≤‡Øç",test:"‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡ÆÆ‡ØÅ‡Æ±‡Øà",testSub:"‡Æ®‡Øá‡Æ∞ ‡Æµ‡Æ∞‡ÆÆ‡Øç‡Æ™‡ØÅ",qnum:"‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø",score:"‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÜ‡Æ£‡Øç ‡ÆÖ‡Æü‡Øç‡Æü‡Øà",review:"‡Æ™‡Æ§‡Æø‡Æ≤‡Øç‡Æï‡Æ≥‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",share:"‡Æ™‡Æï‡Æø‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç",menu:"‡ÆÆ‡ØÜ‡Æ©‡ØÅ",close:"‡ÆÆ‡ØÇ‡Æü‡ØÅ"},
  te:{title:"ITI ‡∞§‡∞Ø‡∞æ‡∞∞‡±Ä",sub:"‡∞é‡∞≤‡∞ï‡±ç‡∞ü‡±ç‡∞∞‡±Ä‡∞∑‡∞ø‡∞Ø‡∞®‡±ç & ‡∞´‡∞ø‡∞ü‡±ç‡∞ü‡∞∞‡±ç",home:"‚Üê ‡∞π‡±ã‡∞Æ‡±ç",select:"‡∞Æ‡±ã‡∞°‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø:",prac:"‡∞™‡±ç‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡±Ä‡∞∏‡±ç ‡∞ï‡±ç‡∞µ‡∞ø‡∞ú‡±ç",pracSub:"‡∞§‡∞ï‡±ç‡∞∑‡∞£ ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç",test:"‡∞™‡∞∞‡±Ä‡∞ï‡±ç‡∞∑ ‡∞Æ‡±ã‡∞°‡±ç",testSub:"‡∞∏‡∞Æ‡∞Ø ‡∞™‡∞∞‡∞ø‡∞Æ‡∞ø‡∞§‡∞ø",qnum:"‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®",score:"‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞°‡±ç",review:"‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞æ‡∞≤‡±Å",share:"‡∞≠‡∞æ‡∞ó‡∞∏‡±ç‡∞µ‡∞æ‡∞Æ‡±ç‡∞Ø‡∞Ç",menu:"‡∞Æ‡±Ü‡∞®‡±Å",close:"‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø"},
  bn:{title:"‡¶Ü‡¶á‡¶ü‡¶ø‡¶Ü‡¶á ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡¶ø",sub:"‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡¶ø‡¶ü‡¶æ‡¶∞",home:"‚Üê ‡¶π‡ßã‡¶Æ",select:"‡¶Æ‡ßã‡¶° ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®:",prac:"‡¶Ö‡¶®‡ßÅ‡¶∂‡ßÄ‡¶≤‡¶® ‡¶ï‡ßÅ‡¶á‡¶ú",pracSub:"‡¶§‡¶æ‡¶§‡ßç‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞",test:"‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßã‡¶°",testSub:"‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßÄ‡¶Æ‡¶æ",qnum:"‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®",score:"‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶°",review:"‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®",share:"‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®",menu:"‡¶Æ‡ßá‡¶®‡ßÅ",close:"‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®"}
};

const t = ui[lang] || ui.en;
document.getElementById('lbl-title').innerText = t.title;
document.getElementById('lbl-subtitle').innerText = t.sub;
document.getElementById('lbl-home').innerText = t.home;
document.getElementById('lbl-select').innerText = t.select;
document.getElementById('lbl-prac').innerText = t.prac;
document.getElementById('lbl-prac-sub').innerText = t.pracSub;
document.getElementById('lbl-test').innerText = t.test;
document.getElementById('lbl-test-sub').innerText = t.testSub;
document.getElementById('lbl-qnum').innerText = t.qnum;
document.getElementById('lbl-scorecard').innerText = t.score;
document.getElementById('btn-review').innerText = t.review;
document.getElementById('btn-share').innerText = t.share;
document.getElementById('btn-menu').innerText = t.menu;
document.getElementById('lbl-review').innerText = t.review;
document.getElementById('btn-close').innerText = t.close;

/* data */
let masterData = [], fullQuestionPool = [], currentSessionQuestions = [], userAnswers = [], idx = 0, score = 0, timerInterval;

/* load CSV via PapaParse */
function loadData(){
  const targetURL = SHEET_URLS[lang] || SHEET_URLS.en;
  Papa.parse(targetURL, {
    download: true, header: true, skipEmptyLines: true,
    complete: function(results){
      // Filter out empty rows (some sheets can return empty objects)
      masterData = results.data.filter(r => Boolean(r.q) && (r.o1 || r.o2 || r.o3 || r.o4));
      if(masterData.length > 0){
        document.getElementById('loading-msg').style.display = 'none';
        const b1 = document.getElementById('btn-practice');
        const b2 = document.getElementById('btn-exam');
        b1.style.opacity = "1"; b1.style.pointerEvents = "auto";
        b2.style.opacity = "1"; b2.style.pointerEvents = "auto";
      } else {
        document.getElementById('loading-msg').innerText = "‚ö†Ô∏è No questions found in this sheet.";
      }
    },
    error: function(err){
      document.getElementById('loading-msg').innerText = "‚ö†Ô∏è Network Error: Could not load questions.";
      console.error(err);
    }
  });
}
loadData();

function shuffleArray(array){ for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];} return array; }

function startPractice(){
  fullQuestionPool = shuffleArray([...masterData]);
  const count = Math.min(5, fullQuestionPool.length);
  currentSessionQuestions = fullQuestionPool.slice(0,count);
  setupScreen('practice');
}

function startExam(){
  const count = Math.min(30, masterData.length);
  fullQuestionPool = shuffleArray([...masterData]);
  currentSessionQuestions = fullQuestionPool.slice(0,count);
  setupScreen('exam');
  startTimer(600);
}

function setupScreen(mode){
  document.getElementById('screen-modes').classList.remove('active');
  document.getElementById('screen-result').classList.remove('active');
  document.getElementById('screen-review').classList.remove('active');
  document.getElementById('screen-quiz').classList.add('active');
  document.getElementById('timer-box').style.display = (mode === 'practice') ? 'none' : 'block';
  idx = 0; score = 0; userAnswers = [];
  loadQ();
}

function safeParseInt(val, fallback=0){
  const n = parseInt(val,10);
  return Number.isNaN(n) ? fallback : n;
}

function loadQ(){
  if(idx >= currentSessionQuestions.length){ showRes(); return; }
  const q = currentSessionQuestions[idx];
  document.getElementById('q-num').innerText = idx + 1;
  document.getElementById('q-text').innerText = q.q || "(No question text)";
  const box = document.getElementById('opts'); box.innerHTML = "";
  document.getElementById('feedback').innerText = "";

  // collect available options (skip empty ones)
  const options = [];
  ['o1','o2','o3','o4'].forEach(k => { if(q[k] && q[k].trim()!=="") options.push(q[k]); });

  // correct index from sheet a (1-based). if invalid, default to 0.
  const correctIndex = Math.max(0, safeParseInt(q.a,1) - 1);
  const btnArray = [];

  // create option buttons
  options.forEach((txt,i) => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn';
    btn.innerText = txt;
    btnArray.push(btn);

    btn.onclick = () => {
      // disable all
      btnArray.forEach(b => b.disabled = true);

      // ensure correctIndex within options range
      const cor = Math.min(correctIndex, options.length - 1);

      userAnswers.push({ q: q.q, sel: i, cor: cor, opts: options, exp: q.explain || "" });

      if(i === cor){
        btn.classList.add('correct'); score++;
        document.getElementById('feedback').innerText = "‚úÖ Correct"; document.getElementById('feedback').style.color = "green";
      } else {
        btn.classList.add('wrong');
        if(btnArray[cor]) btnArray[cor].classList.add('correct');
        document.getElementById('feedback').innerText = "‚ùå Wrong"; document.getElementById('feedback').style.color = "red";
      }

      setTimeout(()=>{ idx++; loadQ(); }, 1000);
    };

    box.appendChild(btn);
  });

  // if there are no options (malformed row) show skip
  if(options.length === 0){
    const skip = document.createElement('div');
    skip.style.color = 'var(--text-sub)';
    skip.style.textAlign = 'center';
    skip.style.margin = '20px 0';
    skip.innerText = '‚ö†Ô∏è This question has no options ‚Äî skipping.';
    box.appendChild(skip);
    setTimeout(()=>{ idx++; loadQ(); }, 800);
  }
}

function showRes(){
  clearInterval(timerInterval);
  document.getElementById('screen-quiz').classList.remove('active');
  document.getElementById('screen-result').classList.add('active');
  const total = currentSessionQuestions.length;
  document.getElementById('score').innerText = score + "/" + total;
  const pct = total ? Math.round((score/total)*100) : 0;
  const msg = document.getElementById('result-msg');
  if(pct >= 80){ msg.innerText = `üéâ Amazing! You scored ${pct}%!`; msg.style.color = "#16a34a"; confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }
  else { msg.innerText = `üìö Keep practicing! You scored ${pct}%.`; msg.style.color = "#0f172a"; }
}

function showReview(){
  document.getElementById('screen-result').classList.remove('active');
  document.getElementById('screen-review').classList.add('active');
  const list = document.getElementById('review-list'); list.innerHTML = "";
  userAnswers.forEach((item, index) => {
    const div = document.createElement('div'); div.className = "review-item";
    const status = (item.sel === item.cor) ? "<span style='color:green'>‚úÖ</span>" : "<span style='color:red'>‚ùå</span>";
    const explainHtml = (item.exp && item.exp !== "") ? `<div class="explanation">üí° <b>Explanation:</b> ${item.exp}</div>` : "";
    const userOpt = item.opts[item.sel] || "(no answer)";
    const correctOpt = item.opts[item.cor] || "(no answer)";
    div.innerHTML = `<div class="review-q">${index+1}. ${item.q}</div>
      <div class="review-ans">You: <b>${userOpt}</b> ${status}</div>
      ${item.sel !== item.cor ? `<div class="ans-right">Ans: ${correctOpt}</div>` : ''}
      ${explainHtml}`;
    list.appendChild(div);
  });
}

function closeReview(){ document.getElementById('screen-review').classList.remove('active'); document.getElementById('screen-result').classList.add('active'); }
function shareScore(){ window.open("https://wa.me/?text=" + encodeURIComponent(`üî• I scored ${score}/${currentSessionQuestions.length} in ITI Taiyaari!`), "_blank"); }
function goToMenu(){ document.getElementById('screen-result').classList.remove('active'); document.getElementById('screen-modes').classList.add('active'); }

function startTimer(duration){
  let timer = duration, m, s;
  function update(){ m = parseInt(timer/60,10); s = parseInt(timer%60,10); m = m<10 ? "0"+m : m; s = s<10 ? "0"+s : s; document.getElementById('time-left').textContent = m + ":" + s; }
  update();
  timerInterval = setInterval(()=>{ if(--timer < 0){ clearInterval(timerInterval); showRes(); } else update(); }, 1000);
}
</script>
</body>
</html>
